(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[698],{1324:(e,t,a)=>{Promise.resolve().then(a.bind(a,2563))},1627:(e,t,a)=>{"use strict";a.d(t,{KG:()=>h,Pu:()=>o,fl:()=>i,pB:()=>m,pq:()=>c,qc:()=>x});var r=a(9390),s=a(8516);let l="inviteCodes";function n(){if(!s.db)throw Error("Firestore 未初始化。請確認環境變數已正確設定。");return s.db}async function i(e,t,a){let s=n();try{let n=await d(t);if(n&&"unused"===n.status)throw Error("此 Email 已有未使用的註冊碼");let i=Math.random().toString(36).substring(2,8).toUpperCase(),o="".concat(Date.now(),"_").concat(i),c={id:o,code:i,email:t.toLowerCase().trim(),name:e.trim(),status:"unused",createdAt:(0,r.O5)(),createdBy:a},m=(0,r.H9)(s,l,o);return await (0,r.BN)(m,c),{...c,createdAt:r.Dc.now()}}catch(e){if(console.error("建立註冊碼失敗:",e),e.message.includes("已有未使用"))throw e;throw Error("無法建立註冊碼，請稍後再試")}}async function d(e){let t=n();try{let a=(0,r.P)((0,r.rJ)(t,l),(0,r._M)("email","==",e.toLowerCase().trim())),s=await (0,r.GG)(a);if(s.empty)return null;let n=s.docs.map(e=>e.data());return n.sort((e,t)=>{var a,r;let s=(null==(a=e.createdAt)?void 0:a.toMillis())||0;return((null==(r=t.createdAt)?void 0:r.toMillis())||0)-s}),n[0]}catch(e){return console.error("查詢註冊碼失敗:",e),null}}async function o(e,t){let a=n();try{let s=(0,r.P)((0,r.rJ)(a,l),(0,r._M)("code","==",e.toUpperCase().trim()),(0,r._M)("email","==",t.toLowerCase().trim())),n=await (0,r.GG)(s);if(n.empty)return{valid:!1,error:"註冊碼無效或不符合此 Email"};let i=n.docs[0].data();if("used"===i.status)return{valid:!1,error:"此註冊碼已被使用"};return{valid:!0,inviteCode:i}}catch(e){return console.error("驗證註冊碼失敗:",e),{valid:!1,error:"驗證失敗，請稍後再試"}}}async function c(e){let t=n();try{let a=(0,r.H9)(t,l,e);await (0,r.mZ)(a,{status:"used",usedAt:(0,r.O5)()})}catch(e){throw console.error("更新註冊碼狀態失敗:",e),Error("無法更新註冊碼狀態")}}async function m(){let e=n();try{let t=(0,r.P)((0,r.rJ)(e,l),(0,r.My)("createdAt","desc"));return(await (0,r.GG)(t)).docs.map(e=>e.data())}catch(e){throw console.error("取得註冊碼列表失敗:",e),Error("無法取得註冊碼列表")}}let u=["ai@autolab.cloud"];async function x(e,t){return!!t&&u.includes(t.toLowerCase())}function h(e){return u.includes(e.toLowerCase())}},1871:(e,t,a)=>{"use strict";a.d(t,{A:()=>m});var r=a(5155),s=a(2115),l=a(2619),n=a.n(l),i=a(63),d=a(8826),o=a(8337),c=a(1627);function m(){var e,t,a;let[l,m]=(0,s.useState)(!1),u=(0,i.usePathname)(),{user:x,signOut:h}=(0,d.A)(),{t:p}=(0,o.o)(),g=null!=x&&!!x.email&&(0,c.KG)(x.email),y=[{href:"/dashboard",label:p.sidebar.dashboard,icon:"\uD83D\uDCCA",available:!0},{href:"/content-clone",label:p.sidebar.contentClone,icon:"✨",available:!0},{href:"/customer-lens",label:p.sidebar.customerLens,icon:"\uD83D\uDD0D",available:!0},{href:"/proposal-machine",label:p.sidebar.proposalMachine,icon:"\uD83D\uDCB0",available:!0},{href:"/follow-up",label:p.sidebar.followUp,icon:"\uD83D\uDD04",available:!0}],f=async()=>{try{await h()}catch(e){console.error("登出失敗:",e)}};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>m(!l),className:"lg:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-md","aria-label":"Toggle menu",children:(0,r.jsx)("svg",{className:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l?(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"}):(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})})}),l&&(0,r.jsx)("div",{className:"lg:hidden fixed inset-0 bg-black/50 z-30",onClick:()=>m(!1)}),(0,r.jsx)("aside",{className:"\n          fixed top-0 left-0 z-40 h-full w-64 bg-white shadow-lg\n          transform transition-transform duration-300 ease-in-out\n          lg:translate-x-0 lg:static lg:z-auto\n          ".concat(l?"translate-x-0":"-translate-x-full","\n        "),children:(0,r.jsxs)("div",{className:"flex flex-col h-full",children:[(0,r.jsx)("div",{className:"p-6 border-b border-gray-100",children:(0,r.jsxs)(n(),{href:"/dashboard",className:"block",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-blue-600",children:"CLOSER"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Close More, Work Less"})]})}),(0,r.jsx)("div",{className:"px-6 py-4 bg-gray-50 border-b border-gray-100",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-blue-600 font-medium",children:(null==x||null==(e=x.displayName)?void 0:e.charAt(0))||(null==x||null==(t=x.email)?void 0:t.charAt(0))||"?"})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:(null==x?void 0:x.displayName)||"使用者"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 truncate",children:null==x?void 0:x.email})]})]})}),(0,r.jsxs)("nav",{className:"flex-1 px-4 py-6 overflow-y-auto",children:[(0,r.jsx)("ul",{className:"space-y-2",children:y.map(e=>{var t;return(0,r.jsx)("li",{children:e.available?(0,r.jsxs)(n(),{href:e.href,onClick:()=>m(!1),className:"\n                        flex items-center gap-3 px-4 py-3 rounded-lg\n                        transition-colors duration-200\n                        ".concat(("/dashboard"===(t=e.href)?"/dashboard"===u:u.startsWith(t))?"bg-blue-50 text-blue-600":"text-gray-600 hover:bg-gray-50 hover:text-gray-900","\n                      "),children:[(0,r.jsx)("span",{className:"text-xl",children:e.icon}),(0,r.jsx)("span",{className:"font-medium",children:e.label})]}):(0,r.jsxs)("div",{className:"flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 cursor-not-allowed",children:[(0,r.jsx)("span",{className:"text-xl opacity-50",children:e.icon}),(0,r.jsx)("span",{className:"font-medium",children:e.label}),(0,r.jsx)("span",{className:"ml-auto text-xs bg-gray-100 px-2 py-1 rounded",children:p.dashboard.comingSoon})]})},e.href)})}),(0,r.jsx)("div",{className:"my-6 border-t border-gray-100"}),(0,r.jsxs)(n(),{href:"/profile",onClick:()=>m(!1),className:"\n                flex items-center gap-3 px-4 py-3 rounded-lg\n                transition-colors duration-200\n                ".concat("/profile"===u?"bg-blue-50 text-blue-600":"text-gray-600 hover:bg-gray-50 hover:text-gray-900","\n              "),children:[(0,r.jsx)("span",{className:"text-xl",children:"\uD83D\uDC64"}),(0,r.jsx)("span",{className:"font-medium",children:p.sidebar.myProfile})]}),g&&(0,r.jsxs)(n(),{href:"/admin",onClick:()=>m(!1),className:"\n                  flex items-center gap-3 px-4 py-3 rounded-lg mt-2\n                  transition-colors duration-200\n                  ".concat("/admin"===u?"bg-purple-50 text-purple-600":"text-gray-600 hover:bg-gray-50 hover:text-gray-900","\n                "),children:[(0,r.jsx)("span",{className:"text-xl",children:"⚙️"}),(0,r.jsx)("span",{className:"font-medium",children:(null==(a=p.admin)?void 0:a.title)||"管理後台"})]})]}),(0,r.jsx)("div",{className:"p-4 border-t border-gray-100",children:(0,r.jsxs)("button",{onClick:f,className:"w-full flex items-center justify-center gap-2 px-4 py-3 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200",children:[(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})}),(0,r.jsx)("span",{className:"font-medium",children:p.sidebar.logout})]})})]})})]})}},2563:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c});var r=a(5155),s=a(2115),l=a(63),n=a(8826),i=a(8337),d=a(1871),o=a(1627);function c(){var e,t,a,c,m,u,x,h,p,g,y;let[f,b]=(0,s.useState)([]),[j,v]=(0,s.useState)(!0),[N,w]=(0,s.useState)(!1),[C,k]=(0,s.useState)(""),[L,E]=(0,s.useState)(""),[M,S]=(0,s.useState)(!1),[A,_]=(0,s.useState)(""),[D,G]=(0,s.useState)(null),P=(0,l.useRouter)(),{user:B,loading:W}=(0,n.A)(),{t:q}=(0,i.o)();(0,s.useEffect)(()=>{!async function(){W||(B?await (0,o.qc)(B.uid)?(w(!0),z()):P.push("/dashboard"):P.push("/"))}()},[B,W,P]);let z=async()=>{v(!0);try{let e=await (0,o.pB)();b(e)}catch(e){console.error("載入註冊碼失敗:",e),_("無法載入註冊碼列表")}finally{v(!1)}},O=async e=>{if(e.preventDefault(),B){S(!0),_("");try{await (0,o.fl)(C,L,B.uid),k(""),E(""),await z()}catch(e){_(e.message)}finally{S(!1)}}},H=async(e,t)=>{try{await navigator.clipboard.writeText(e),G(t),setTimeout(()=>G(null),2e3)}catch(e){console.error("複製失敗:",e)}};return W||j||!N?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsx)("div",{className:"text-gray-500",children:(null==(y=q.common)?void 0:y.loading)||"載入中..."})}):(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50 flex",children:[(0,r.jsx)(d.A,{}),(0,r.jsx)("main",{className:"flex-1 lg:ml-0 p-4 lg:p-8",children:(0,r.jsxs)("div",{className:"max-w-6xl mx-auto",children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:(null==(e=q.admin)?void 0:e.title)||"管理後台"}),(0,r.jsx)("p",{className:"text-gray-600 mt-1",children:(null==(t=q.admin)?void 0:t.inviteCodes)||"註冊碼管理"})]}),(0,r.jsxs)("div",{className:"card mb-8",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:(null==(a=q.admin)?void 0:a.addStudent)||"新增學員"}),(0,r.jsxs)("form",{onSubmit:O,className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"form-label",children:(null==(c=q.admin)?void 0:c.studentName)||"學員姓名"}),(0,r.jsx)("input",{type:"text",value:C,onChange:e=>k(e.target.value),className:"form-input",placeholder:"請輸入學員姓名",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"form-label",children:(null==(m=q.admin)?void 0:m.studentEmail)||"學員 Email"}),(0,r.jsx)("input",{type:"email",value:L,onChange:e=>E(e.target.value),className:"form-input",placeholder:"student@email.com",required:!0})]})]}),A&&(0,r.jsx)("div",{className:"text-red-500 text-sm",children:A}),(0,r.jsx)("button",{type:"submit",disabled:M,className:"btn-primary disabled:opacity-50",children:M?"產生中...":(null==(u=q.admin)?void 0:u.generateCode)||"產生註冊碼"})]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:(null==(x=q.admin)?void 0:x.inviteCodes)||"註冊碼列表"}),0===f.length?(0,r.jsx)("p",{className:"text-gray-500 text-center py-8",children:"尚無註冊碼，請先新增學員"}):(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,r.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(h=q.admin)?void 0:h.studentName)||"姓名"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Email"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(p=q.register)?void 0:p.inviteCode)||"註冊碼"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(g=q.admin)?void 0:g.status)||"狀態"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"建立時間"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"操作"})]})}),(0,r.jsx)("tbody",{children:f.map(e=>{var t,a,s,l,n;return(0,r.jsxs)("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[(0,r.jsx)("td",{className:"py-3 px-4 text-gray-900",children:e.name}),(0,r.jsx)("td",{className:"py-3 px-4 text-gray-600",children:e.email}),(0,r.jsx)("td",{className:"py-3 px-4",children:(0,r.jsx)("code",{className:"bg-gray-100 px-2 py-1 rounded text-blue-600 font-mono",children:e.code})}),(0,r.jsx)("td",{className:"py-3 px-4",children:(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat("used"===e.status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"),children:"used"===e.status?(null==(t=q.admin)?void 0:t.used)||"已使用":(null==(a=q.admin)?void 0:a.unused)||"未使用"})}),(0,r.jsx)("td",{className:"py-3 px-4 text-gray-500 text-sm",children:(n=e.createdAt)?n.toDate().toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}),(0,r.jsx)("td",{className:"py-3 px-4",children:(0,r.jsx)("button",{onClick:()=>H(e.code,e.id),className:"text-blue-600 hover:text-blue-700 text-sm font-medium",disabled:"used"===e.status,children:D===e.id?(null==(s=q.common)?void 0:s.copied)||"已複製!":(null==(l=q.admin)?void 0:l.copyCode)||"複製"})})]},e.id)})})]})})]})]})})]})}}},e=>{e.O(0,[153,563,320,176,168,441,493,358],()=>e(e.s=1324)),_N_E=e.O()}]);