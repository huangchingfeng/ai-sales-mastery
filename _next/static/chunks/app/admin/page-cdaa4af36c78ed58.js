(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[698],{161:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>b});var a=r(5155),s=r(2115),l=r(63),n=r(8826),i=r(8337),d=r(1871),c=r(4246),o=r(1627),u=r(9390),m=r(8516);let x="courses";function h(){if(!m.db)throw Error("Firestore 未初始化。請確認環境變數已正確設定。");return m.db}async function g(e,t,r){let a=h();try{let s="course_".concat(Date.now()),l={id:s,name:e.trim(),date:u.Dc.fromDate(t),studentCount:0,createdAt:(0,u.O5)(),createdBy:r},n=(0,u.H9)(a,x,s);return await (0,u.BN)(n,l),{...l,createdAt:u.Dc.now()}}catch(e){throw console.error("建立課程失敗:",e),Error("無法建立課程，請稍後再試")}}async function y(){let e=h();try{let t=(0,u.P)((0,u.rJ)(e,x),(0,u.My)("date","desc"));return(await (0,u.GG)(t)).docs.map(e=>e.data())}catch(e){throw console.error("取得課程列表失敗:",e),Error("無法取得課程列表")}}async function p(e){let t=h();try{let r=(0,u.P)((0,u.rJ)(t,x),(0,u._M)("name","==",e.trim())),a=await (0,u.GG)(r);if(a.empty)return null;return a.docs[0].data()}catch(e){return console.error("查詢課程失敗:",e),null}}async function f(e,t){let r=h();try{let a=(0,u.H9)(r,x,e);await (0,u.mZ)(a,{studentCount:t})}catch(e){throw console.error("更新課程學員數失敗:",e),Error("無法更新課程學員數")}}async function v(e,t){let r=await p(e);if(r)return r;let a=e.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/),s=new Date;if(a){let[,e,t,r]=a;s=new Date(parseInt(e),parseInt(t)-1,parseInt(r))}return await g(e,s,t)}function b(){var e,t,r,u,m,x,h,g,p,b,j,N,w,D,C,S,E,A,_;let[k,F]=(0,s.useState)([]),[P,O]=(0,s.useState)(null),[T,B]=(0,s.useState)([]),[G,L]=(0,s.useState)(!0),[H,I]=(0,s.useState)(!1),[R,W]=(0,s.useState)(!1),[J,M]=(0,s.useState)(null),[q,U]=(0,s.useState)(null),[Z,z]=(0,s.useState)(!1),K=(0,s.useRef)(null),Q=(0,l.useRouter)(),{user:V,loading:X}=(0,n.A)(),{t:Y}=(0,i.o)();(0,s.useEffect)(()=>{!async function(){X||(V?await (0,o.qc)(V.uid,V.email||void 0)?(I(!0),$()):Q.push("/dashboard"):Q.push("/"))}()},[V,X,Q]);let $=async()=>{L(!0);try{let e=await y();F(e)}catch(e){console.error("載入課程失敗:",e)}finally{L(!1)}},ee=(0,s.useCallback)(async e=>{try{let t=await (0,o.Se)(e.id);B(t)}catch(e){console.error("載入學員失敗:",e),B([])}},[]),et=async e=>{if(V){W(!0),M(null);try{let t=await new Promise((t,r)=>{let a=new FileReader;a.onload=e=>{try{var a;let r=new Uint8Array(null==(a=e.target)?void 0:a.result),s=c.LF(r,{type:"array"}),l=s.Sheets[s.SheetNames[0]],n=c.Wp.sheet_to_json(l,{header:1,range:1}).filter(e=>Array.isArray(e)&&e.length>=3&&e[0]&&e[1]&&e[2]).map(e=>({course:String(e[0]).trim(),name:String(e[1]).trim(),email:String(e[2]).trim()}));t(n)}catch(e){r(e)}},a.onerror=r,a.readAsArrayBuffer(e)});if(0===t.length)return void M({success:!1,count:0});let r={};for(let e of t)r[e.course]||(r[e.course]=[]),r[e.course].push(e);let a=0;for(let[e,t]of Object.entries(r)){let r=await v(e,V.uid);for(let e of t)try{await (0,o.fl)(e.name,e.email,V.uid,r.id),a++}catch(e){console.warn("建立註冊碼失敗（可能已存在）:",e)}let s=await (0,o.Se)(r.id);await f(r.id,s.length)}M({success:!0,count:a}),await $()}catch(e){console.error("匯入失敗:",e),M({success:!1,count:0})}finally{W(!1)}}},er=e=>{e.preventDefault(),e.stopPropagation(),"dragenter"===e.type||"dragover"===e.type?z(!0):"dragleave"===e.type&&z(!1)},ea=async(e,t)=>{try{await navigator.clipboard.writeText(e),U(t),setTimeout(()=>U(null),2e3)}catch(e){console.error("複製失敗:",e)}};return X||G||!H?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,a.jsx)("div",{className:"text-gray-500",children:(null==(_=Y.common)?void 0:_.loading)||"載入中..."})}):(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50 flex",children:[(0,a.jsx)(d.A,{}),(0,a.jsx)("main",{className:"flex-1 lg:ml-0 p-4 lg:p-8",children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:(null==(e=Y.admin)?void 0:e.title)||"管理後台"}),(0,a.jsx)("p",{className:"text-gray-600 mt-1",children:(null==(t=Y.admin)?void 0:t.inviteCodes)||"註冊碼管理"})]}),(0,a.jsxs)("div",{className:"card mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:(null==(r=Y.admin)?void 0:r.uploadExcel)||"上傳 Excel"}),(0,a.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ".concat(Z?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"),onDragEnter:er,onDragLeave:er,onDragOver:er,onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),z(!1),e.dataTransfer.files&&e.dataTransfer.files[0]){let t=e.dataTransfer.files[0];(t.name.endsWith(".xlsx")||t.name.endsWith(".xls"))&&et(t)}},onClick:()=>{var e;return null==(e=K.current)?void 0:e.click()},children:[(0,a.jsx)("input",{ref:K,type:"file",accept:".xlsx,.xls",onChange:e=>{e.target.files&&e.target.files[0]&&et(e.target.files[0])},className:"hidden"}),R?(0,a.jsxs)("div",{className:"text-gray-600",children:[(0,a.jsx)("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"}),(null==(u=Y.admin)?void 0:u.importing)||"匯入中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-4xl mb-2",children:"\uD83D\uDCE4"}),(0,a.jsx)("p",{className:"text-gray-600 mb-1",children:(null==(m=Y.admin)?void 0:m.dragDropHint)||"拖曳 Excel 檔案到此處，或點擊選擇檔案"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:(null==(x=Y.admin)?void 0:x.supportedFormats)||"支援格式：.xlsx, .xls"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:(null==(h=Y.admin)?void 0:h.excelFormat)||"Excel 欄位格式：課程日期/名稱、姓名、Email"})]})]}),J&&(0,a.jsx)("div",{className:"mt-4 p-3 rounded-lg ".concat(J.success?"bg-green-50 text-green-700":"bg-red-50 text-red-700"),children:J.success?((null==(g=Y.admin)?void 0:g.importSuccess)||"成功匯入 {count} 位學員").replace("{count}",String(J.count)):(null==(p=Y.admin)?void 0:p.importError)||"匯入失敗"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"card",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:["\uD83D\uDCDA ",(null==(b=Y.admin)?void 0:b.courseList)||"課程列表"]}),0===k.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-8",children:(null==(j=Y.admin)?void 0:j.noCourses)||"尚無課程"}):(0,a.jsx)("div",{className:"space-y-2",children:k.map(e=>{var t;return(0,a.jsxs)("button",{onClick:()=>{O(e),ee(e)},className:"w-full text-left p-3 rounded-lg transition-colors ".concat((null==P?void 0:P.id)===e.id?"bg-blue-50 border-2 border-blue-500":"bg-gray-50 hover:bg-gray-100 border-2 border-transparent"),children:[(0,a.jsx)("div",{className:"font-medium text-gray-900 truncate",children:e.name}),(0,a.jsxs)("div",{className:"text-sm text-gray-500 mt-1",children:[e.studentCount," ",(null==(t=Y.admin)?void 0:t.students)||"位學員"]})]},e.id)})})]}),(0,a.jsxs)("div",{className:"card lg:col-span-2",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:["\uD83D\uDCCB ",(null==(N=Y.admin)?void 0:N.studentList)||"學員名單",P&&(0,a.jsxs)("span",{className:"text-sm font-normal text-gray-500 ml-2",children:["- ",P.name]})]}),P?0===T.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-8",children:(null==(D=Y.admin)?void 0:D.noStudents)||"此課程尚無學員"}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(C=Y.admin)?void 0:C.studentName)||"姓名"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Email"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(S=Y.admin)?void 0:S.inviteCodes)||"註冊碼"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(E=Y.admin)?void 0:E.status)||"狀態"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(A=Y.admin)?void 0:A.copyCode)||"操作"})]})}),(0,a.jsx)("tbody",{children:T.map(e=>{var t,r,s,l;return(0,a.jsxs)("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[(0,a.jsx)("td",{className:"py-3 px-4 text-gray-900",children:e.name}),(0,a.jsx)("td",{className:"py-3 px-4 text-gray-600 text-sm",children:e.email}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("code",{className:"bg-gray-100 px-2 py-1 rounded text-blue-600 font-mono text-sm",children:e.code})}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat("used"===e.status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"),children:"used"===e.status?(null==(t=Y.admin)?void 0:t.used)||"已使用":(null==(r=Y.admin)?void 0:r.unused)||"未使用"})}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("button",{onClick:()=>ea(e.code,e.id),className:"text-blue-600 hover:text-blue-700 text-sm font-medium",disabled:"used"===e.status,children:q===e.id?(null==(s=Y.common)?void 0:s.copied)||"已複製!":(null==(l=Y.admin)?void 0:l.copyCode)||"複製"})})]},e.id)})})]})}):(0,a.jsx)("p",{className:"text-gray-500 text-center py-8",children:(null==(w=Y.admin)?void 0:w.selectCourse)||"請選擇課程查看學員"})]})]})]})})]})}},1324:(e,t,r)=>{Promise.resolve().then(r.bind(r,161))},2383:()=>{},3686:()=>{}},e=>{e.O(0,[153,563,524,320,176,168,871,441,493,358],()=>e(e.s=1324)),_N_E=e.O()}]);