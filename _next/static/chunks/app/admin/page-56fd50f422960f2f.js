(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[698],{161:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>b});var a=r(5155),s=r(2115),l=r(63),n=r(8826),i=r(8337),d=r(1871),o=r(1627),c=r(9390),u=r(8516);let m="courses";function x(){if(!u.db)throw Error("Firestore 未初始化。請確認環境變數已正確設定。");return u.db}async function h(e,t,r){let a=x();try{let s="course_".concat(Date.now()),l={id:s,name:e.trim(),date:c.Dc.fromDate(t),studentCount:0,createdAt:(0,c.O5)(),createdBy:r},n=(0,c.H9)(a,m,s);return await (0,c.BN)(n,l),{...l,createdAt:c.Dc.now()}}catch(e){throw console.error("建立課程失敗:",e),Error("無法建立課程，請稍後再試")}}async function g(){let e=x();try{let t=(0,c.P)((0,c.rJ)(e,m),(0,c.My)("date","desc"));return(await (0,c.GG)(t)).docs.map(e=>e.data())}catch(e){throw console.error("取得課程列表失敗:",e),Error("無法取得課程列表")}}async function y(e){let t=x();try{let r=(0,c.P)((0,c.rJ)(t,m),(0,c._M)("name","==",e.trim())),a=await (0,c.GG)(r);if(a.empty)return null;return a.docs[0].data()}catch(e){return console.error("查詢課程失敗:",e),null}}async function p(e,t){let r=x();try{let a=(0,c.H9)(r,m,e);await (0,c.mZ)(a,{studentCount:t})}catch(e){throw console.error("更新課程學員數失敗:",e),Error("無法更新課程學員數")}}async function f(e,t){let r=await y(e);if(r)return r;let a=e.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/),s=new Date;if(a){let[,e,t,r]=a;s=new Date(parseInt(e),parseInt(t)-1,parseInt(r))}return await h(e,s,t)}function b(){var e,t,c,u,m,x,h,y,b,v,j,N,w,D,C,S,E,A,_,k;let[P,F]=(0,s.useState)([]),[O,T]=(0,s.useState)(null),[B,G]=(0,s.useState)([]),[I,L]=(0,s.useState)(!0),[R,H]=(0,s.useState)(!1),[W,J]=(0,s.useState)(!1),[M,q]=(0,s.useState)(null),[U,Z]=(0,s.useState)(null),[z,K]=(0,s.useState)(!1),Q=(0,s.useRef)(null),V=(0,l.useRouter)(),{user:X,loading:Y}=(0,n.A)(),{t:$,language:ee}=(0,i.o)();(0,s.useEffect)(()=>{!async function(){Y||(X?await (0,o.qc)(X.uid,X.email||void 0)?(H(!0),et()):V.push("/dashboard"):V.push("/"))}()},[X,Y,V]);let et=async()=>{L(!0);try{let e=await g();F(e)}catch(e){console.error("載入課程失敗:",e)}finally{L(!1)}},er=(0,s.useCallback)(async e=>{try{let t=await (0,o.Se)(e.id);G(t)}catch(e){console.error("載入學員失敗:",e),G([])}},[]),ea=async e=>{let t=await Promise.all([r.e(524),r.e(436)]).then(r.bind(r,4246));return new Promise((r,a)=>{let s=new FileReader;s.onload=e=>{try{var s;let a=new Uint8Array(null==(s=e.target)?void 0:s.result),l=t.read(a,{type:"array"}),n=l.Sheets[l.SheetNames[0]],i=t.utils.sheet_to_json(n,{header:1,range:1}).filter(e=>Array.isArray(e)&&e.length>=3&&e[0]&&e[1]&&e[2]).map(e=>({course:String(e[0]).trim(),name:String(e[1]).trim(),email:String(e[2]).trim()}));r(i)}catch(e){a(e)}},s.onerror=a,s.readAsArrayBuffer(e)})},es=async e=>{if(X){J(!0),q(null);try{let t=await ea(e);if(0===t.length)return void q({success:!1,count:0});let r={};for(let e of t)r[e.course]||(r[e.course]=[]),r[e.course].push(e);let a=0;for(let[e,t]of Object.entries(r)){let r=await f(e,X.uid);for(let e of t)try{await (0,o.fl)(e.name,e.email,X.uid,r.id),a++}catch(e){console.warn("建立註冊碼失敗（可能已存在）:",e)}let s=await (0,o.Se)(r.id);await p(r.id,s.length)}q({success:!0,count:a}),await et()}catch(e){console.error("匯入失敗:",e),q({success:!1,count:0})}finally{J(!1)}}},el=e=>{e.preventDefault(),e.stopPropagation(),"dragenter"===e.type||"dragover"===e.type?K(!0):"dragleave"===e.type&&K(!1)},en=async(e,t)=>{try{await navigator.clipboard.writeText(e),Z(t),setTimeout(()=>Z(null),2e3)}catch(e){console.error("複製失敗:",e)}};return Y||I||!R?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,a.jsx)("div",{role:"status","aria-label":"Loading",className:"text-gray-500",children:(null==(k=$.common)?void 0:k.loading)||"載入中..."})}):(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50 flex",children:[(0,a.jsx)(d.A,{}),(0,a.jsx)("main",{className:"flex-1 lg:ml-0 p-4 lg:p-8",children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto",children:[(0,a.jsx)("div",{className:"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:(0,a.jsx)("p",{className:"text-sm text-yellow-800",children:(null==(e=$.admin)?void 0:e.adminWarning)||"此為管理員專用頁面，所有操作皆有記錄。請確保 Firestore Security Rules 已正確設定以保護資料安全。"})}),(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:(null==(t=$.admin)?void 0:t.title)||"管理後台"}),(0,a.jsx)("p",{className:"text-gray-600 mt-1",children:(null==(c=$.admin)?void 0:c.inviteCodes)||"註冊碼管理"})]}),(0,a.jsxs)("div",{className:"card mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:(null==(u=$.admin)?void 0:u.uploadExcel)||"上傳 Excel"}),(0,a.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ".concat(z?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"),onDragEnter:el,onDragLeave:el,onDragOver:el,onDrop:e=>{if(e.preventDefault(),e.stopPropagation(),K(!1),e.dataTransfer.files&&e.dataTransfer.files[0]){let t=e.dataTransfer.files[0];(t.name.endsWith(".xlsx")||t.name.endsWith(".xls"))&&es(t)}},onClick:()=>{var e;return null==(e=Q.current)?void 0:e.click()},children:[(0,a.jsx)("input",{ref:Q,type:"file",accept:".xlsx,.xls",onChange:e=>{e.target.files&&e.target.files[0]&&es(e.target.files[0])},className:"hidden"}),W?(0,a.jsxs)("div",{role:"status","aria-label":"Importing",className:"text-gray-600",children:[(0,a.jsx)("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"}),(null==(m=$.admin)?void 0:m.importing)||"匯入中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-4xl mb-2",children:"\uD83D\uDCE4"}),(0,a.jsx)("p",{className:"text-gray-600 mb-1",children:(null==(x=$.admin)?void 0:x.dragDropHint)||"拖曳 Excel 檔案到此處，或點擊選擇檔案"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:(null==(h=$.admin)?void 0:h.supportedFormats)||"支援格式：.xlsx, .xls"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:(null==(y=$.admin)?void 0:y.excelFormat)||"Excel 欄位格式：課程日期/名稱、姓名、Email"})]})]}),M&&(0,a.jsx)("div",{role:"alert",className:"mt-4 p-3 rounded-lg ".concat(M.success?"bg-green-50 text-green-700":"bg-red-50 text-red-700"),children:M.success?((null==(b=$.admin)?void 0:b.importSuccess)||"成功匯入 {count} 位學員").replace("{count}",String(M.count)):(null==(v=$.admin)?void 0:v.importError)||"匯入失敗"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"card",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:["\uD83D\uDCDA ",(null==(j=$.admin)?void 0:j.courseList)||"課程列表"]}),0===P.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-8",children:(null==(N=$.admin)?void 0:N.noCourses)||"尚無課程"}):(0,a.jsx)("div",{className:"space-y-2",children:P.map(e=>{var t;return(0,a.jsxs)("button",{onClick:()=>{T(e),er(e)},className:"w-full text-left p-3 rounded-lg transition-colors ".concat((null==O?void 0:O.id)===e.id?"bg-blue-50 border-2 border-blue-500":"bg-gray-50 hover:bg-gray-100 border-2 border-transparent"),children:[(0,a.jsx)("div",{className:"font-medium text-gray-900 truncate",children:e.name}),(0,a.jsxs)("div",{className:"text-sm text-gray-500 mt-1",children:[e.studentCount," ",(null==(t=$.admin)?void 0:t.students)||"位學員"]})]},e.id)})})]}),(0,a.jsxs)("div",{className:"card lg:col-span-2",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:["\uD83D\uDCCB ",(null==(w=$.admin)?void 0:w.studentList)||"學員名單",O&&(0,a.jsxs)("span",{className:"text-sm font-normal text-gray-500 ml-2",children:["- ",O.name]})]}),O?0===B.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-8",children:(null==(C=$.admin)?void 0:C.noStudents)||"此課程尚無學員"}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(S=$.admin)?void 0:S.studentName)||"姓名"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Email"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(E=$.admin)?void 0:E.inviteCodes)||"註冊碼"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(A=$.admin)?void 0:A.status)||"狀態"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:(null==(_=$.admin)?void 0:_.copyCode)||"操作"})]})}),(0,a.jsx)("tbody",{children:B.map(e=>{var t,r,s,l,n;return(0,a.jsxs)("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[(0,a.jsx)("td",{className:"py-3 px-4 text-gray-900",children:e.name}),(0,a.jsx)("td",{className:"py-3 px-4 text-gray-600 text-sm",children:e.email}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("code",{className:"bg-gray-100 px-2 py-1 rounded text-blue-600 font-mono text-sm",children:e.code})}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat("used"===e.status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"),children:"used"===e.status?(null==(t=$.admin)?void 0:t.used)||"已使用":(null==(r=$.admin)?void 0:r.unused)||"未使用"})}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("button",{onClick:()=>en(e.code,e.id),"aria-label":"".concat((null==(s=$.admin)?void 0:s.copyCode)||"Copy"," ").concat(e.code),className:"text-blue-600 hover:text-blue-700 text-sm font-medium",disabled:"used"===e.status,children:U===e.id?(null==(l=$.common)?void 0:l.copied)||"已複製!":(null==(n=$.admin)?void 0:n.copyCode)||"複製"})})]},e.id)})})]})}):(0,a.jsx)("p",{className:"text-gray-500 text-center py-8",children:(null==(D=$.admin)?void 0:D.selectCourse)||"請選擇課程查看學員"})]})]})]})})]})}},1324:(e,t,r)=>{Promise.resolve().then(r.bind(r,161))}},e=>{e.O(0,[153,563,320,619,168,871,441,493,358],()=>e(e.s=1324)),_N_E=e.O()}]);